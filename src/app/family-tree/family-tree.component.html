<ng-container *ngIf="(contentPage$ | async) as t">
  <p-organizationChart [value]="data" selectionMode="single" (onNodeSelect)="onNodeClick($event)" [collapsible]="true">
    <ng-template let-node pTemplate="person">
      <div class="card-node" [id]="node.data.name" [ngClass]="{ 'highlighted': (highlightedNode?.id) === node.name }"
        [pTooltip]="getTooltipContent(node.data)" [escape]="false" tooltipPosition="top" tooltipStyleClass="node-tooltip"
        (click)="onNodeTooltipClick(node)">
        <div *ngIf="node.data.married === 'Y'; else singleView" class="married-view flex gap-4">
          <div class="half-card text-center">
            <ng-container *ngIf="node.data.avatar; else defaultAvatar1">
              <img [src]="node.data.avatar" class="w-16 h-16 rounded-full mb-2" />
            </ng-container>
            <ng-template #defaultAvatar1>
              <div class="w-16 h-16 rounded-full bg-gray-200 flex items-center justify-center mb-2 mx-auto">
                <i class="pi pi-user text-xl text-gray-600"></i>
              </div>
            </ng-template>

            <strong>{{ node.label }}</strong>
            <div *ngIf="node.data.dob">ğŸŸ¢ {{ t['mft_dob'] }}: {{ node.data.dob | date }}</div>
            <div *ngIf="!node.data.isAlive">ğŸ”´ {{ t['mft_died_on'] }}: {{ node.data.diedOn | date }}</div>
          </div>

          <div class="half-card text-center">
            <ng-container *ngIf="node.data.partnerAvatar; else defaultAvatar2">
              <img [src]="node.data.partnerAvatar" class="w-16 h-16 rounded-full mb-2" />
            </ng-container>
            <ng-template #defaultAvatar2>
              <div class="w-16 h-16 rounded-full bg-gray-200 flex items-center justify-center mb-2 mx-auto">
                <i class="pi pi-user text-xl text-gray-600"></i>
              </div>
            </ng-template>

            <strong>{{ node.data.partnerName }}</strong>
            <div *ngIf="node.data.partnerDob">ğŸŸ¢ {{ t['mft_partner_dob'] }}: {{ node.data.partnerDob | date }}</div>
            <div *ngIf="!node.data.partnerIsAlive && node.data.partnerDiedOn">ğŸ”´ {{ t['mft_partner_died_on'] }}: {{ node.data.partnerDiedOn |
              date }}</div>
          </div>
        </div>

        <ng-template #singleView>
          <div class="text-center">
            <ng-container *ngIf="node.data.avatar; else defaultSoloAvatar">
              <img [src]="node.data.avatar" class="w-16 h-16 rounded-full mb-2" />
            </ng-container>
            <ng-template #defaultSoloAvatar>
              <div class="w-16 h-16 rounded-full bg-gray-200 flex items-center justify-center mb-2 mx-auto">
                <i class="pi pi-user text-xl text-gray-600"></i>
              </div>
            </ng-template>

            <strong>{{ node.label }} ğŸ‘¤</strong>
            <div *ngIf="node.data.dob">ğŸŸ¢ {{ t['mft_dob'] }}: {{ node.data.dob | date }}</div>
            <div *ngIf="!node.data.isAlive && node.data.diedOn">ğŸ”´ {{ t['mft_died_on'] }}: {{ node.data.diedOn | date }}</div>
          </div>
        </ng-template>
      </div>
    </ng-template>
  </p-organizationChart>

  <p-dialog header="{{ t['mft_family_member_details'] || t['mft_member_details'] || 'Family Member Details' }}" [(visible)]="displayDialog" [modal]="true">
    <div class="dialog-content">
      <div>
        <button pButton [label]="t['mft_edit_add_details'] || 'Edit/Add Details'" (click)="toggleEditForm()" *ngIf="!showForm"></button>
      </div>

      <div *ngIf="showForm" class="form-container">
        <div class="field">
          <label>{{ t['mft_name'] }}</label>
          <input pInputText [(ngModel)]="form.name" />
        </div>

        <div class="field">
          <label>{{ t['mft_gender'] }}</label>
          <p-selectButton [options]="genders" [(ngModel)]="form.gender" optionLabel="label"
            optionValue="value"></p-selectButton>
        </div>

        <div class="field">
          <label>{{ t['mft_dob'] }}</label>
          <p-calendar [(ngModel)]="form.dob" dateFormat="yy-mm-dd"></p-calendar>
        </div>

        <div class="field">
          <label>{{ t['mft_is_alive'] }}</label>
          <div class="flex gap-2">
            <p-radioButton name="isAlive" [value]="true" [(ngModel)]="form.isAlive" inputId="aliveYes"></p-radioButton>
            <label for="aliveYes">{{ t['mft_yes'] || 'Yes' }}</label>
            <p-radioButton name="isAlive" [value]="false" [(ngModel)]="form.isAlive" inputId="aliveNo"></p-radioButton>
            <label for="aliveNo">{{ t['mft_no'] || 'No' }}</label>
          </div>
        </div>

        <div class="field" *ngIf="form.isAlive === false">
          <label>{{ t['mft_died_on'] }}</label>
          <p-calendar [(ngModel)]="form.diedOn" dateFormat="yy-mm-dd"></p-calendar>
        </div>

        <div class="field">
          <label>{{ t['mft_married'] }}</label>
          <div class="flex gap-2 align-items-center">
            <p-radioButton name="married" value="Y" [(ngModel)]="form.married" inputId="marriedYes"></p-radioButton>
            <label for="marriedYes">{{ t['mft_married_yes'] || t['mft_married'] || 'Y' }}</label>
            <p-radioButton name="married" value="N" [(ngModel)]="form.married" inputId="marriedNo"></p-radioButton>
            <label for="marriedNo">{{ t['mft_married_no'] || 'N' }}</label>
          </div>
        </div>

        <div class="field" *ngIf="form.married === 'Y'">
          <label>{{ t['mft_partner_name'] }}</label>
          <input pInputText [(ngModel)]="form.partnerName" />

          <label>{{ t['mft_partner_dob'] }}</label>
          <p-calendar [(ngModel)]="form.partnerDob" dateFormat="yy-mm-dd"></p-calendar>

          <label>{{ t['mft_partner_alive'] }}</label>
          <div class="flex gap-2">
            <p-radioButton name="partnerIsAlive" [value]="true" [(ngModel)]="form.partnerIsAlive"
              inputId="partnerAliveYes"></p-radioButton>
            <label for="partnerAliveYes">{{ t['mft_yes'] || 'Yes' }}</label>
            <p-radioButton name="partnerIsAlive" [value]="false" [(ngModel)]="form.partnerIsAlive"
              inputId="partnerAliveNo"></p-radioButton>
            <label for="partnerAliveNo">{{ t['mft_no'] || 'No' }}</label>
          </div>

          <div class="field" *ngIf="form.partnerIsAlive === false">
            <label>{{ t['mft_partner_died_on'] || t['mft_partner_died_on'] }}</label>
            <p-calendar [(ngModel)]="form.partnerDiedOn" dateFormat="yy-mm-dd"></p-calendar>
          </div>
        </div>
      </div>

      <div class="field" *ngIf="!isEditMode">
        <label>{{ t['mft_add_as'] }}</label>
        <p-selectButton [options]="relationTypes" [(ngModel)]="addingRelation" optionLabel="label"
          optionValue="value"></p-selectButton>
      </div>

      <div class="flex flex-wrap gap-2 justify-between mt-4">
        <div class="flex gap-2">
          <button pButton [label]="t['mft_save_details']" class="btn-save" (click)="saveDetails()"
            [disabled]="!isFormChanged()"></button>
          <button *ngIf="!isEditMode" pButton [label]="t['mft_add_member']" class="btn-add" (click)="addFamilyMember()" [disabled]="!form.name"></button>
        </div>
        <button *ngIf="selectedNode && getTotalNodeCount(data) > 1" pButton [label]="t['mft_delete']" icon="pi pi-trash"
          class="p-button-danger" (click)="deleteNode(selectedNode)" pTooltip="{{ t['mft_delete_node'] || 'Delete Node' }}"
          tooltipPosition="top"></button>
      </div>
    </div>
  </p-dialog>

  <p-dialog header="{{ t['mft_details'] || 'Details' }}" [(visible)]="tooltipDialogVisible" [modal]="true" [style]="{width: '350px'}"
    [baseZIndex]="10000" *ngIf="tooltipData">
    <div [innerHTML]="getTooltipContent(tooltipData)"></div>
  </p-dialog>

  <p-confirmDialog></p-confirmDialog>
</ng-container>
